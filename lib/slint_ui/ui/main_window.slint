import { VerticalBox, HorizontalBox, ScrollView, LineEdit, Button, Palette, TextEdit } from "std-widgets.slint";

export struct Message {
    content: string,
    timestamp: string,
}

export component MainWindow inherits Window {
    in-out property <string> node-fingerprint: "";
    in-out property <string> current-mode: "hybrid";
    in property <[Message]> messages: [];
    property <int> message-count: messages.length;
    property <bool> auto-scroll-enabled: true;

    callback send-command(string);

    title: "Radix Relay";
    min-width: 600px;
    min-height: 400px;
    preferred-width: 1000px;
    preferred-height: 700px;
    background: Palette.background;

    VerticalBox {
        padding: 16px;
        spacing: 12px;

        Rectangle {
            height: 32px;
            background: Palette.alternate-background;
            border-radius: 4px;

            HorizontalBox {
                padding-left: 12px;
                padding-right: 12px;
                alignment: start;

                Text {
                    text: "Node: " + node-fingerprint + " | Mode: " + current-mode;
                    font-size: 13px;
                    font-weight: 600;
                    color: Palette.foreground;
                    vertical-alignment: center;
                }
            }
        }

        message-scroll := ScrollView {
            vertical-stretch: 1;

            property <length> max-scroll: min(0px, -message-box.preferred-height + message-scroll.visible-height);
            property <length> threshold: 50px;
            property <int> last-count: message-count;

            changed viewport-y => {
                auto-scroll-enabled = abs(self.viewport-y - max-scroll) < threshold;
            }

            changed last-count => {
                if (auto-scroll-enabled) {
                    self.viewport-y = max-scroll;
                }
            }

            message-box := VerticalBox {
                spacing: 0px;
                padding: 4px;
                alignment: start;

                for msg in messages: Rectangle {
                    height: self.preferred-height;
                    background: transparent;

                    HorizontalBox {
                        spacing: 8px;

                        Text {
                            width: 80px;
                            text: msg.timestamp;
                            font-size: 11px;
                            color: Palette.foreground.transparentize(0.3);
                            horizontal-alignment: right;
                            vertical-alignment: top;
                        }

                        Text {
                            text: msg.content;
                            font-size: 13px;
                            color: Palette.foreground;
                            vertical-alignment: top;
                            wrap: word-wrap;
                            horizontal-stretch: 1;
                        }
                    }
                }
            }
        }

        Rectangle {
            height: 48px;
            background: Palette.alternate-background;
            border-radius: 4px;

            HorizontalBox {
                padding: 8px;
                spacing: 8px;

                Text {
                    text: "[â‡Œ]";
                    font-size: 14px;
                    font-weight: 600;
                    color: Palette.foreground;
                    vertical-alignment: center;
                }

                input := LineEdit {
                    placeholder-text: "Type command...";
                    horizontal-stretch: 1;
                    font-size: 13px;

                    accepted => {
                        send-command(self.text);
                        self.text = "";
                    }
                }

                Button {
                    text: "Send";
                    min-width: 80px;

                    clicked => {
                        send-command(input.text);
                        input.text = "";
                    }
                }
            }
        }
    }
}
