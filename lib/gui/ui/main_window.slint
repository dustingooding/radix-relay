import { VerticalBox, HorizontalBox, ScrollView, LineEdit, Button, Palette, TextEdit } from "std-widgets.slint";
import "./fonts/FiraCode-Regular.ttf";
import "./fonts/FiraCode-Bold.ttf";

export global AppColors {
    out property <color> background: #0a0e0f;
    out property <color> surface: #121a1d;
    out property <color> surface-elevated: #1a2428;
    out property <color> primary-green: #00ff41;
    out property <color> secondary-green: #00cc33;
    out property <color> dim-green: #00802a;
    out property <color> text-primary: #00ff41;
    out property <color> text-secondary: #7a9e88;
    out property <color> text-dim: #4a6658;
    out property <color> border: #1e3a2f;
}

export struct Message {
    content: string,
    timestamp: string,
}

export struct Contact {
    rdx-fingerprint: string,
    user-alias: string,
    has-active-session: bool,
}

export component MainWindow inherits Window {
    in-out property <string> node-fingerprint: "";
    in-out property <string> current-mode: "hybrid";
    in property <[Message]> messages: [];
    in property <[Contact]> contacts: [];
    property <int> message-count: messages.length;
    property <bool> auto-scroll-enabled: true;

    callback send-command(string);

    title: "Radix Relay";
    min-width: 600px;
    min-height: 400px;
    preferred-width: 1000px;
    preferred-height: 700px;
    background: AppColors.background;
    default-font-family: "Fira Code";

    VerticalBox {
        padding: 16px;
        spacing: 12px;

        Rectangle {
            height: 32px;
            background: AppColors.surface;
            border-radius: 4px;
            border-width: 1px;
            border-color: AppColors.border;

            HorizontalBox {
                padding-left: 12px;
                padding-right: 12px;
                alignment: start;

                Text {
                    text: "Node: " + node-fingerprint + " | Mode: " + current-mode;
                    font-size: 13px;
                    font-weight: 600;
                    color: AppColors.text-primary;
                    vertical-alignment: center;
                }
            }
        }

        HorizontalBox {
            vertical-stretch: 1;
            spacing: 12px;

            message-scroll := ScrollView {
                horizontal-stretch: 1;

                property <length> max-scroll: min(0px, -message-box.preferred-height + message-scroll.visible-height);
                property <length> threshold: 50px;
                property <int> last-count: message-count;

                changed viewport-y => {
                    auto-scroll-enabled = abs(self.viewport-y - max-scroll) < threshold;
                }

                changed last-count => {
                    if (auto-scroll-enabled) {
                        self.viewport-y = max-scroll;
                    }
                }

                message-box := VerticalBox {
                    spacing: 0px;
                    padding: 4px;
                    alignment: start;

                    for msg in messages: Rectangle {
                        height: self.preferred-height;
                        background: transparent;

                        HorizontalBox {
                            spacing: 8px;

                            Text {
                                width: 80px;
                                text: msg.timestamp;
                                font-size: 11px;
                                color: AppColors.text-dim;
                                horizontal-alignment: right;
                                vertical-alignment: top;
                            }

                            Text {
                                text: msg.content;
                                font-size: 13px;
                                color: AppColors.text-secondary;
                                vertical-alignment: top;
                                wrap: word-wrap;
                                horizontal-stretch: 1;
                            }
                        }
                    }
                }
            }

            Rectangle {
                width: 250px;
                background: AppColors.surface;
                border-radius: 4px;
                border-width: 1px;
                border-color: AppColors.border;

                VerticalBox {
                    padding: 8px;
                    spacing: 4px;

                    Text {
                        text: "Contacts";
                        font-size: 13px;
                        font-weight: 600;
                        color: AppColors.text-primary;
                        horizontal-alignment: center;
                    }

                    Rectangle {
                        height: 1px;
                        background: AppColors.border;
                    }

                    ScrollView {
                        vertical-stretch: 1;

                        VerticalBox {
                            spacing: 0px;
                            padding: 4px;
                            alignment: start;

                            for contact in contacts: Rectangle {
                                height: self.preferred-height;
                                background: transparent;

                                VerticalBox {
                                    padding: 4px;
                                    spacing: 2px;

                                    Text {
                                        text: contact.user-alias;
                                        font-size: 12px;
                                        color: AppColors.text-primary;
                                        font-weight: 600;
                                    }

                                    Text {
                                        text: contact.rdx-fingerprint;
                                        font-size: 10px;
                                        color: AppColors.text-dim;
                                        overflow: elide;
                                    }

                                    Text {
                                        text: contact.has-active-session ? "● Active" : "○ Inactive";
                                        font-size: 10px;
                                        color: contact.has-active-session ? AppColors.secondary-green : AppColors.text-dim;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        Rectangle {
            height: 48px;
            background: AppColors.surface;
            border-radius: 4px;
            border-width: 1px;
            border-color: AppColors.border;

            HorizontalBox {
                padding: 8px;
                spacing: 8px;

                Text {
                    text: "[⇌]";
                    font-size: 14px;
                    font-weight: 600;
                    color: AppColors.primary-green;
                    vertical-alignment: center;
                }

                input := LineEdit {
                    placeholder-text: "Type command...";
                    horizontal-stretch: 1;
                    font-size: 13px;

                    accepted => {
                        send-command(self.text);
                        self.text = "";
                    }
                }

                Button {
                    text: "Send";
                    min-width: 80px;

                    clicked => {
                        send-command(input.text);
                        input.text = "";
                    }
                }
            }
        }
    }
}
